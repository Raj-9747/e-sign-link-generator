<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client E-Sign Link Generator</title>
  <style>
    /* ------------------- Base Styles ------------------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7f6;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 3rem 1rem;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      padding: 3rem;
      max-width: 850px;
      width: 100%;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header { text-align: center; margin-bottom: 2rem; }
    .icon { width: 60px; height: 60px; margin: 0 auto 1rem; font-size: 32px; }
    h2 { color: #3f51b5; font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; }
    .subtitle { color: #666; font-size: 1rem; }

    /* ------------------- Progress Stepper ------------------- */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2rem 0 3rem;
      position: relative;
    }

    .stepper-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .stepper-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      text-align: center;
      z-index: 2;
    }

    .stepper-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      background-color: #e0e0e0;
      color: #777;
      transition: all 0.3s;
    }

    .stepper-label { font-size: 0.85rem; color: #777; transition: color 0.3s; }

    .stepper-item.active .stepper-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stepper-item.active .stepper-label { color: #333; font-weight: 600; }

    /* ------------------- Form Elements ------------------- */
    .instruction-box {
      padding: 1rem 1.5rem;
      background-color: #e8f0fe;
      border-left: 5px solid #3f51b5;
      border-radius: 5px;
      color: #3f51b5;
      font-weight: 500;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      font-size: 0.95rem;
    }

    .find-client-controls { display: flex; gap: 1rem; }
    
    .find-client-controls input {
      flex-grow: 1;
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      background: #f9f9f9;
    }

    .find-client-controls button {
      flex-shrink: 0;
      width: auto;
      min-width: 150px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    form { display: flex; flex-direction: column; gap: 1.2rem; }
    .form-group { position: relative; }
    .input-row { display: flex; gap: 1rem; }
    .input-row > div { flex: 1; }

    select, input[type="text"], input[type="email"], input[type="date"], input[type="number"] {
      width: 100%;
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      background: #f9f9f9;
      transition: all 0.3s ease;
    }
    
    input:read-only { background-color: #eaeaea; color: #666; cursor: not-allowed; }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      background: white;
    }

    /* Buttons */
    .full-submit-button, .button-style {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      display: block;
      text-align: center;
      text-decoration: none;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }
    
    .full-submit-button:hover, .button-style:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .secondary-button {
      background: white;
      color: #764ba2;
      border: 2px solid #667eea;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    .secondary-button:hover { background: #f4f4ff; }
    
    .secondary-action-link {
        display: block; margin-top: 1rem; text-align: center;
        color: #667eea; font-size: 0.95rem; text-decoration: none;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Notifications */
    .notification {
      position: fixed; top: 20px; right: 20px;
      padding: 1rem 1.5rem; border-radius: 10px;
      color: white; font-weight: 600; z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: slideInRight 0.3s ease-out;
    }
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .notification.error { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

    /* Conditional Section styles */
    .conditional-section { display: none; padding: 1rem; background: #fafafa; border-radius: 10px; border: 1px solid #eee; }

    /* ------------------- Checkbox Grid Styles ------------------- */
    .doc-category-title {
        color: #3f51b5;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0.5rem;
    }
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 0.8rem;
    }
    .checkbox-item {
        display: flex;
        align-items: flex-start;
        font-size: 0.9rem;
        color: #444;
        background: #f9f9f9;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #eee;
        transition: all 0.2s;
        cursor: pointer;
    }
    .checkbox-item:hover {
        background: #f0f4ff;
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .checkbox-item input[type="checkbox"] {
        margin-right: 0.75rem;
        margin-top: 0.2rem;
        width: 18px;
        height: 18px;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    @media (max-width: 600px) {
      .container { padding: 2rem 1.5rem; }
      .find-client-controls { flex-direction: column; }
      .input-row { flex-direction: column; gap: 1rem; }
      .checkbox-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="icon">üöÄ</div>
      <h2 style="color: #3f51b5;">Client E-Sign Link Generator</h2>
      <p class="subtitle">Complete the process to generate agreement</p>
    </div>

    <!-- Progress Stepper -->
    <div class="stepper">
      <div class="stepper-line"></div>
      <div class="stepper-item active" id="progress_step1">
        <div class="stepper-number">1</div>
        <div class="stepper-label">Find Client</div>
      </div>
      <div class="stepper-item" id="progress_step2">
        <div class="stepper-number">2</div>
        <div class="stepper-label">Details</div>
      </div>
      <div class="stepper-item" id="progress_step3">
        <div class="stepper-number">3</div>
        <div class="stepper-label">Documents</div>
      </div>
      <div class="stepper-item" id="progress_step4">
        <div class="stepper-number">4</div>
        <div class="stepper-label">Send</div>
      </div>
    </div>

    <!-- ------------------- Step 1: Find Client ------------------- -->
    <div id="step1_container">
      <div class="instruction-box">
        <span style="margin-right: 0.75rem; font-size: 1.2rem;">üîé</span>
        <span>Search by <strong>Client ID</strong> or <strong>Phone Number</strong>.</span>
      </div>

      <div class="form-group">
        <label>Search Client by Phone Number</label>
        <div class="find-client-controls">
          <input type="text" id="search_phone" placeholder="e.g., 917990700545" />
          <button type="button" id="findClientPhoneBtn">Find Client</button>
        </div>
      </div>

      <div style="text-align: center; color: #999; margin: 1.5rem 0; font-size: 0.9rem;">OR</div>

      <div class="form-group">
        <label>Search Client by ID</label>
        <div class="find-client-controls">
          <input type="text" id="search_client_id" placeholder="e.g., CID12345" />
          <button type="button" id="findClientIdBtn">Find Client</button>
        </div>
      </div>

      <a href="#" id="proceedManualBtn" class="secondary-action-link">Proceed to manual entry</a>
    </div>

    <!-- FORM WRAPPER FOR STEP 2 & 3 -->
    <form id="esignForm">
      
      <!-- ------------------- Step 2: Review Details ------------------- -->
      <div id="step2_container" style="display: none;">
        <button type="button" id="backToSearchBtn" class="secondary-button" style="width: auto; margin-bottom: 2rem;">
          ‚Üê Back to Search
        </button>

        <h3 style="margin-bottom: 1.5rem; color: #333; text-align: center;">Retainer Agreement Details</h3>

        <!-- Retainer Selection -->
        <div class="form-group">
            <label for="select_retainer" style="color: #3f51b5;">Select Retainer Type</label>
            <!-- Values kept as numbers for easy logic handling, Text will be sent to backend -->
            <select id="select_retainer" name="retainer_type" required>
                <option value="">-- Select Option --</option>
                <option value="1">1 : Initial Consultation- TDOT</option>
                <option value="2">2 : Retainer Agreement -TDOT- LMIA (Employer's Legal Rep)</option>
                <option value="3">3 : Retainer Agreement - TDOT- PA + Inviter</option>
                <option value="4">4 : Retainer Agreement - TDOT- PA</option>
            </select>
        </div>
        
        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 0.5rem 0 1.5rem;">

        <!-- Common Fields -->
        <div class="form-group">
          <label for="agreement_date">Agreement Date</label>
          <input type="date" id="agreement_date" name="agreement_date" required />
        </div>

        <div class="input-row">
            <div class="form-group">
              <label id="lbl_fname">Client First Name</label>
              <input type="text" id="fname_primary" name="fname_primary" placeholder="First Name" required />
            </div>
            <div class="form-group">
              <label id="lbl_lname">Client Last Name</label>
              <input type="text" id="lname_primary" name="lname_primary" placeholder="Last Name" required />
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label id="lbl_email">Client Email</label>
                <input type="email" id="client_email" name="client_email" placeholder="email@example.com" required />
            </div>
            <div class="form-group">
                <label id="lbl_phone">Client Phone</label>
                <input type="text" id="client_phone" name="client_phone" placeholder="+1 (555) 123-4567" required />
            </div>
        </div>
        
        <!-- Dynamic Sections -->
        <div class="form-group conditional-section" id="sec_app_type">
             <label>Type of Application</label>
             <input type="text" id="application_type" name="application_type" readonly />
        </div>

        <div class="form-group conditional-section" id="sec_client_address">
             <label id="lbl_client_address">Address</label>
             <input type="text" id="client_address" name="client_address" placeholder="Full Address" />
        </div>

        <div class="conditional-section" id="sec_consultation">
            <div class="input-row">
                <div class="form-group">
                    <label>Amount Paid ($)</label>
                    <input type="number" step="0.01" name="consultation_amount" placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Duration of Consultation</label>
                    <input type="text" name="consultation_duration" placeholder="e.g. 1 Hour" />
                </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label>Consultation Date</label>
                <input type="date" name="consultation_date" />
            </div>
        </div>

        <div class="conditional-section" id="sec_company">
            <div class="form-group">
                <label>Full Name of Employer Company</label>
                <input type="text" name="company_name" placeholder="Company Name" />
            </div>
            <div class="form-group">
                <label>Company Address</label>
                <input type="text" name="company_address" placeholder="Company Full Address" />
            </div>
            <div class="form-group">
                <label>Company Phone Number</label>
                <input type="text" name="company_phone" placeholder="Company Phone" />
            </div>
        </div>

        <div class="conditional-section" id="sec_inviter">
            <h4 style="margin-bottom:1rem; color:#3f51b5;">Inviter / Sponsor Details</h4>
            <div class="form-group">
                <label>Name of Inviter/Sponsor</label>
                <input type="text" name="inviter_name" placeholder="Full Name" />
            </div>
            <div class="form-group">
                <label>Address of Inviter/Sponsor</label>
                <input type="text" name="inviter_address" placeholder="Full Address" />
            </div>
            <div class="input-row">
                <div class="form-group">
                    <label>Inviter Phone</label>
                    <input type="text" name="inviter_phone" />
                </div>
                <div class="form-group">
                    <label>Inviter Email</label>
                    <input type="email" name="inviter_email" />
                </div>
            </div>
        </div>

        <div class="conditional-section" id="sec_financials">
            <h4 style="margin-bottom:1rem; color:#3f51b5;">Payment Details</h4>
            <div class="form-group">
                <label>Summary Fees (CAD)</label>
                <input type="number" step="0.01" name="payment_terms_summary_fees" placeholder="0.00" />
            </div>
            <div class="input-row">
                <div class="form-group">
                    <label>Professional Taxes (CAD)</label>
                    <input type="number" step="0.01" name="professional_taxes" placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Total Amount ($)</label>
                    <input type="number" step="0.01" name="total_amount" placeholder="0.00" />
                </div>
            </div>
        </div>
        
        <!-- Navigation Button for Step 2 -->
        <div style="margin-top: 2rem;">
            <button type="button" id="goToStep3Btn" class="full-submit-button">Next ‚Üí</button>
        </div>
      </div>

      <!-- ------------------- Step 3: Select Documents ------------------- -->
      <div id="step3_container" style="display: none;">
        <button type="button" id="backToStep2Btn" class="secondary-button" style="width: auto; margin-bottom: 2rem;">
            ‚Üê Back to Details
        </button>

        <h3 style="text-align: center; margin-bottom: 1rem;">Select Documents</h3>
        <p style="text-align: center; color: #666; margin-bottom: 2rem;">
            Check the documents required for this application.<br>
            <span style="font-size: 0.9rem; color:#888;">Selected items will be sent to the backend.</span>
        </p>

        <!-- Permanent Application Section -->
        <div class="doc-category-title">Permanent Application</div>
        <div class="checkbox-grid">
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Non Express Entry Application- Annex A"> Non Express Entry Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Federal PR Application- Annex A"> Federal PR Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Express Entry Application- Annex A"> Express Entry Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Canadian Experience Class Application- Annex A"> Canadian Experience Class Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Spousal- Common Law Sponsorship Application"> Spousal- Common Law Sponsorship Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Provincial Nominee Program Application- Annex A"> Provincial Nominee Program Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="Parents-Grandparents Sponsorship Application"> Parents-Grandparents Sponsorship Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="permanent_docs[]" value="LMIA- Annex A"> LMIA- Annex A
            </label>
        </div>

        <!-- Temporary Application Section -->
        <div class="doc-category-title">Temporary Application</div>
        <div class="checkbox-grid">
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Visitor Record (change of status) Application- Annex A"> Visitor Record (change of status) Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Concurrent Work Permit Application- Annex A"> Concurrent Work Permit Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Bridging Open Work Permit (BOWP) Application"> Bridging Open Work Permit (BOWP) Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Permanent Resident Card (PR) Application- Annex A"> Permanent Resident Card (PR) Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Visitor Visa (Outside canada) Application- Annex A"> Visitor Visa (Outside canada) Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Parents-Grandparents Supervisa Application- Annex A"> Parents-Grandparents Supervisa Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Canadian Citizenship Application- Annex A"> Canadian Citizenship Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Spousal Open Work Permit Extension Application"> Spousal Open Work Permit Extension Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Spousal Open Work Permit Application (SOWP)"> Spousal Open Work Permit Application (SOWP)
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="SCLPC Work Permit Application- Annex A"> SCLPC Work Permit Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="LMIA based Work Permit Extension Application- Annex A"> LMIA based Work Permit Extension Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="LMIA based Work Permit Application- Annex A"> LMIA based Work Permit Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Restoration of Status Application- Annex A"> Restoration of Status Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Post Graduate Work Permit Extension Application"> Post Graduate Work Permit Extension Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Post Graduate Work Permit Application- Annex A"> Post Graduate Work Permit Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Permanent Resident Travel Document (PRTD) Application"> Permanent Resident Travel Document (PRTD) Application
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Study Permit Extension Application- Annex A"> Study Permit Extension Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Temporary Resident Visa (TRV) Application- Annex A"> Temporary Resident Visa (TRV) Application- Annex A
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="temporary_docs[]" value="Study Permit Application- Annex A"> Study Permit Application- Annex A
            </label>
        </div>

        <input type="hidden" name="esign_status" value="false" />
        <input type="hidden" name="payment_status" value="false" />

        <div style="margin-top: 2rem;">
            <button type="submit" id="submitBtn" class="full-submit-button">
              <span id="btnText">Generate & Send Link</span>
            </button>
        </div>
      </div>
    </form>

    <!-- ------------------- Step 4: Final Review ------------------- -->
    <div id="step4_container" style="display: none; text-align: center;">
      <h3 style="margin-bottom: 1rem; color: #333;">Document Prepared</h3>
      <p style="margin-bottom: 2rem; color: #666;">
        Your document has been generated. Please review it before sending.
      </p>
      <a href="#" id="editDocLink" target="_blank" class="button-style" style="margin-bottom: 1rem;">
        Review & Edit Document
      </a>
      
      <button id="backBtn" class="secondary-button" style="margin-top: 1rem;">
        Go Back to Edit
      </button>

      <button id="sendMailBtn" class="button-style" style="margin-top: 1rem;">
        <span id="sendBtnText">Looks Good, Send Mail</span>
      </button>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // CONFIGURATION
    // ----------------------------------------------------
    const ESIGN_WEBHOOK_URL = "https://n8n.srv898271.hstgr.cloud/webhook/create-and-send-esign-link";
    const FIND_CLIENT_WEBHOOK_URL = "https://n8n.srv898271.hstgr.cloud/webhook/find-client-details-esign";

    const containers = {
      1: document.getElementById('step1_container'),
      2: document.getElementById('step2_container'),
      3: document.getElementById('step3_container'),
      4: document.getElementById('step4_container')
    };
    
    const progressItems = {
      1: document.getElementById('progress_step1'),
      2: document.getElementById('progress_step2'),
      3: document.getElementById('progress_step3'),
      4: document.getElementById('progress_step4')
    };

    const esignForm = document.getElementById("esignForm");
    let finalizationData = {};

    // ----------------------------------------------------
    // HELPER FUNCTIONS
    // ----------------------------------------------------
    function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 4000);
    }

    function updateStep(stepNumber) {
      Object.values(containers).forEach(el => el.style.display = 'none');
      containers[stepNumber].style.display = 'block';

      Object.values(progressItems).forEach(el => el.classList.remove('active'));
      for (let i = 1; i <= stepNumber; i++) {
        progressItems[i].classList.add('active');
      }
      window.scrollTo(0, 0);
    }

    function hideAllSections() {
        ['sec_app_type', 'sec_client_address', 'sec_consultation', 'sec_company', 'sec_inviter', 'sec_financials']
        .forEach(id => document.getElementById(id).style.display = 'none');
    }

    // ----------------------------------------------------
    // DYNAMIC FORM LOGIC
    // ----------------------------------------------------
    const selectRetainer = document.getElementById('select_retainer');
    
    const lblFname = document.getElementById('lbl_fname');
    const lblLname = document.getElementById('lbl_lname');
    const lblPhone = document.getElementById('lbl_phone');
    const lblEmail = document.getElementById('lbl_email');
    const lblClientAddress = document.getElementById('lbl_client_address');
    const inputAppType = document.getElementById('application_type');

    selectRetainer.addEventListener('change', () => {
        const val = selectRetainer.value;
        const text = selectRetainer.options[selectRetainer.selectedIndex].text;
        
        hideAllSections();
        
        // Default Labels
        lblFname.textContent = "Client First Name";
        lblLname.textContent = "Client Last Name";
        lblEmail.textContent = "Client Email";
        lblPhone.textContent = "Client Phone";
        lblClientAddress.textContent = "Address";

        if (val === '1') {
            document.getElementById('sec_client_address').style.display = 'block';
            document.getElementById('sec_consultation').style.display = 'block';
            lblFname.textContent = "Name (First)"; lblLname.textContent = "Name (Last)";
            lblPhone.textContent = "Tel"; lblEmail.textContent = "E-mail";
        } else if (val === '2') {
            document.getElementById('sec_company').style.display = 'block';
            document.getElementById('sec_financials').style.display = 'block';
            lblFname.textContent = "Legal Rep First Name"; lblLname.textContent = "Legal Rep Last Name";
            lblPhone.textContent = "Legal Rep Phone"; lblEmail.textContent = "Legal Rep Email";
        } else if (val === '3') {
            document.getElementById('sec_app_type').style.display = 'block';
            document.getElementById('sec_client_address').style.display = 'block';
            document.getElementById('sec_inviter').style.display = 'block';
            document.getElementById('sec_financials').style.display = 'block';
            lblFname.textContent = "Principal Applicant First Name"; lblLname.textContent = "Principal Applicant Last Name";
            inputAppType.value = text;
            lblClientAddress.textContent = "Address (PA)";
        } else if (val === '4') {
            document.getElementById('sec_app_type').style.display = 'block';
            document.getElementById('sec_client_address').style.display = 'block';
            document.getElementById('sec_financials').style.display = 'block';
            lblFname.textContent = "Principal Applicant First Name"; lblLname.textContent = "Principal Applicant Last Name";
            inputAppType.value = text;
            lblClientAddress.textContent = "Client Address";
        }
    });

    // ----------------------------------------------------
    // STEP NAVIGATION LOGIC
    // ----------------------------------------------------
    document.getElementById('goToStep3Btn').onclick = () => {
        if(esignForm.reportValidity()) {
            updateStep(3);
        }
    };
    document.getElementById('backToSearchBtn').onclick = () => updateStep(1);
    document.getElementById('backToStep2Btn').onclick = () => updateStep(2);
    document.getElementById('backBtn').onclick = () => updateStep(3);

    // ----------------------------------------------------
    // STEP 1: FIND CLIENT
    // ----------------------------------------------------
    async function performSearch(val, type, btn) {
        if(!val) return showNotification("Please enter a value", "error");
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Searching...';

        try {
            const res = await fetch(FIND_CLIENT_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(type === 'phone' ? { phone_number: val } : { client_id: val })
            });

            const data = await res.json();
            
            if (data.status === "success" && data.client) {
                const c = data.client;
                const parts = (c.client_name || c.customerName || "").split(" ");
                document.getElementById('fname_primary').value = parts[0] || "";
                document.getElementById('lname_primary').value = parts.slice(1).join(" ") || "";
                document.getElementById('client_email').value = c.client_email || "";
                document.getElementById('client_phone').value = c.client_phone || (type==='phone'?val:"");
                if(c.address) document.getElementById('client_address').value = c.address;
                showNotification("‚úÖ Client Found!", "success");
            } else {
                ['fname_primary', 'lname_primary', 'client_email'].forEach(id => document.getElementById(id).value = '');
                showNotification("Client not found. Manual entry required.", "error");
            }
            updateStep(2);
        } catch (e) {
            console.error(e);
            showNotification("Search error. Enter manually.", "error");
            updateStep(2);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    document.getElementById('findClientPhoneBtn').onclick = () => performSearch(document.getElementById('search_phone').value.trim(), 'phone', document.getElementById('findClientPhoneBtn'));
    document.getElementById('findClientIdBtn').onclick = () => performSearch(document.getElementById('search_client_id').value.trim(), 'client_id', document.getElementById('findClientIdBtn'));
    document.getElementById('proceedManualBtn').onclick = (e) => { e.preventDefault(); updateStep(2); };

    // ----------------------------------------------------
    // FINAL SUBMISSION (GENERATE)
    // ----------------------------------------------------
    esignForm.onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const btnTxt = document.getElementById('btnText');
        
        btn.disabled = true;
        btnTxt.innerHTML = '<span class="spinner"></span>Generating...';

        const formData = new FormData(esignForm);
        const jsonData = {};

        // 1. Build JSON Data (Handle Arrays)
        formData.forEach((value, key) => {
            if(key.endsWith('[]')) {
                const cleanKey = key.slice(0, -2);
                if(!jsonData[cleanKey]) {
                    jsonData[cleanKey] = [];
                }
                jsonData[cleanKey].push(value);
            } else {
                jsonData[key] = value;
            }
        });

        // ------------------------------------------------------
        // FIX: RETAINER TYPE OVERRIDE (Send Name instead of ID)
        // ------------------------------------------------------
        const sel = document.getElementById('select_retainer');
        if (sel.selectedIndex > 0) {
            let text = sel.options[sel.selectedIndex].text;
            // Remove "1 : " prefix to send clean text
            if(text.indexOf(" : ") > -1) {
                text = text.split(" : ")[1];
            }
            jsonData['retainer_type'] = text;
        }

        console.log("Sending Payload:", jsonData);

        try {
            const res = await fetch(ESIGN_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData)
            });
            const result = await res.json();

            if (res.ok) {
                finalizationData = result;
                if(result.documentId) {
                    document.getElementById('editDocLink').href = `https://docs.google.com/document/d/${result.documentId}/edit`;
                }
                updateStep(4);
                showNotification("‚úÖ Document Generated!", "success");
            } else {
                showNotification("Generation Failed", "error");
            }
        } catch (err) {
            showNotification("Connection Error", "error");
        } finally {
            btn.disabled = false;
            btnTxt.textContent = "Generate & Send Link";
        }
    };

    // ----------------------------------------------------
    // SEND EMAIL ACTION
    // ----------------------------------------------------
    document.getElementById('sendMailBtn').onclick = async () => {
        const btn = document.getElementById('sendMailBtn');
        const btnTxt = document.getElementById('sendBtnText');
        const originalTxt = btnTxt.textContent;
        
        btn.disabled = true;
        btnTxt.innerHTML = '<span class="spinner"></span>Sending...';

        try {
            const res = await fetch(ESIGN_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(finalizationData)
            });

            if (res.ok) {
                document.getElementById('step4_container').innerHTML = `<h3>‚úÖ Email Sent!</h3><p>You may close this window.</p>`;
                showNotification("‚úÖ Sent successfully!", "success");
            } else {
                showNotification("Failed to send", "error");
                btn.disabled = false;
                btnTxt.textContent = originalTxt;
            }
        } catch (e) {
            showNotification("Error sending email", "error");
            btn.disabled = false;
            btnTxt.textContent = originalTxt;
        }
    };

    updateStep(1);
  </script>
</body>
</html>
