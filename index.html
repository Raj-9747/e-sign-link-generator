<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client E-Sign Link Generator</title>
  <style>
    /* ------------------- Base Styles (Kept from Original) ------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7f6;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 3rem 1rem;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      padding: 3rem;
      max-width: 600px;
      width: 100%;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      font-size: 32px;
    }

    h2 {
      color: #3f51b5;
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #666;
      font-size: 1rem;
    }

    /* ------------------- Progress Stepper Styles ------------------- */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2rem 0 3rem;
      position: relative;
    }

    .stepper-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .stepper-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      text-align: center;
      z-index: 2;
    }

    .stepper-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      background-color: #e0e0e0;
      color: #777;
      transition: all 0.3s;
    }

    .stepper-label {
      font-size: 0.9rem;
      color: #777;
      transition: color 0.3s;
    }

    .stepper-item.active .stepper-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stepper-item.active .stepper-label {
      color: #333;
      font-weight: 600;
    }

    /* ------------------- Step 1 - Find Client Styles ------------------- */
    .instruction-box {
      padding: 1rem 1.5rem;
      background-color: #e8f0fe;
      border-left: 5px solid #3f51b5;
      border-radius: 5px;
      color: #3f51b5;
      font-weight: 500;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      font-size: 0.95rem;
    }

    .instruction-box .emoji {
      font-size: 1.2rem;
      margin-right: 0.75rem;
    }

    .find-client-controls {
      display: flex;
      gap: 1rem;
    }

    .find-client-controls input {
      flex-grow: 1;
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      background: #f9f9f9;
    }

    .find-client-controls input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .find-client-controls button {
      flex-shrink: 0;
      width: auto;
      min-width: 150px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .find-client-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    /* ------------------- General Button/Form Styles (Adapted) ------------------- */
    form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    /* Style for combined date/text inputs for Line Items */
    .line-item-group {
        display: flex;
        gap: 1rem;
    }

    .line-item-group > div {
        flex: 1;
    }


    .form-group {
      position: relative;
    }
    
    /* Style for the select dropdown */
    select {
      width: 100%;
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f9f9f9;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20292.36%20292.36%22%3E%3Cpath%20fill%3D%22%23667eea%22%20d%3D%22M287.15%2084.14L146.18%20225.11%205.21%2084.14z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 0.8rem;
    }

    select:focus {
        outline: none;
        border-color: #667eea;
        background-color: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }


    label {
      display: block;
      color: #555;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="date"] {
      width: 100%;
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f9f9f9;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .full-submit-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      width: 100%;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: slideInRight 0.3s ease-out;
      z-index: 1000;
      max-width: 350px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }

    .button-style {
      display: block;
      width: 100%;
      text-decoration: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      text-align: center;
    }

    .button-style:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .secondary-button {
      display: block;
      width: 100%;
      text-decoration: none;
      background: white;
      color: #764ba2;
      border: 2px solid #667eea;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .secondary-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      background: #f4f4ff;
    }

    .secondary-action-link {
        display: block;
        margin-top: 1rem;
        text-align: center;
        color: #667eea;
        font-size: 0.95rem;
        text-decoration: none;
        transition: color 0.2s;
    }
    .secondary-action-link:hover {
        text-decoration: underline;
    }

    /* Style for line item wrappers that need to be hidden/shown */
    .line-item-wrapper {
        display: none;
    }

    @media (max-width: 600px) {
      .container {
        padding: 2rem 1.5rem;
      }

      h2 {
        font-size: 1.8rem;
      }

      .find-client-controls {
        flex-direction: column;
        gap: 0.75rem;
      }
      .find-client-controls button {
        min-width: 100%;
      }
      
      .line-item-group {
        flex-direction: column;
        gap: 1.5rem; /* Match other form-group gaps */
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <div class="icon">üöÄ</div>
      <h2 style="color: #3f51b5;">Client E-Sign Link Generator</h2>
      <p class="subtitle">Complete the retainer generation process in 3 easy steps</p>
    </div>

    <!-- Progress Stepper -->
    <div class="stepper">
      <div class="stepper-line"></div>
      <div class="stepper-item active" id="progress_step1">
        <div class="stepper-number">1</div>
        <div class="stepper-label">Find Client</div>
      </div>
      <div class="stepper-item" id="progress_step2">
        <div class="stepper-number">2</div>
        <div class="stepper-label">Review Details</div>
      </div>
      <div class="stepper-item" id="progress_step3">
        <div class="stepper-number">3</div>
        <div class="stepper-label">Send Retainer</div>
      </div>
    </div>

    <!-- ------------------- Step 1: Find Client (Active) ------------------- -->
    <div id="findClientStep">
      <div class="instruction-box">
        <span class="emoji">üì±</span>
        <span>Enter the client's phone number to retrieve their details from our system.</span>
      </div>

      <div class="form-group">
        <label for="search_phone">Enter Phone Number</label>
        <div class="find-client-controls">
          <input type="text" id="search_phone" name="search_phone" placeholder="e.g., 917990700545" />
          <button type="button" id="findClientBtn">
            <span class="emoji">üîé</span> Find Client
          </button>
        </div>
        <a href="#" id="proceedManualBtn" class="secondary-action-link">
          Client not found, or proceed to manual entry
        </a>
      </div>
    </div>

    <!-- ------------------- Step 2: Review Details (Hidden Initially) ------------------- -->
    <div id="reviewDetailsStep" style="display: none;">
      
      <!-- Back Button for Step 2 -->
      <button id="backToSearchBtn" class="secondary-button" style="margin-bottom: 2rem; padding: 0.75rem 1rem;">
        ‚Üê Back to Search
      </button>

      <h3 style="margin-bottom: 1.5rem; color: #333; text-align: center;">Review Client & Agreement Details</h3>
      
      <form id="esignForm">
        
        <!-- Client Name Details -->
        <div class="form-group">
          <label for="fname_primary">Client First Name</label>
          <input type="text" id="fname_primary" name="fname_primary" placeholder="Client First Name" required />
        </div>

        <div class="form-group">
          <label for="lname_primary">Client Last Name</label>
          <input type="text" id="lname_primary" name="lname_primary" placeholder="Client Last Name" required />
        </div>

        <!-- Client Contact Details -->
        <div class="form-group">
          <label for="client_email">Client Email Address</label>
          <input type="email" id="client_email" name="client_email" placeholder="client@example.com" required />
        </div>
        
        <div class="form-group">
          <label for="client_phone">Client Phone Number (Optional)</label>
          <input type="text" id="client_phone" name="client_phone" placeholder="+1 (555) 123-4567" />
        </div>
        
        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 0.5rem 0 2rem;">

        <!-- Agreement Details -->
        <div class="form-group">
          <label for="agreement_date">Agreement Date</label>
          <input type="date" id="agreement_date" name="agreement_date" required />
        </div>

        <!-- Select Retainer Dropdown -->
        <div class="form-group">
            <label for="select_retainer">Select Retainer</label>
            <select id="select_retainer" name="select_retainer">
                <option value="">-- Select Retainer (Optional) --</option>
                <option value="Class 3">Class 3</option>
                <option value="Citizenship">Citizenship</option>
                <option value="Sponsorship">Sponsorship</option>
            </select>
        </div>

        <!-- NEW: Payment Milestones Dropdown -->
        <div class="form-group" id="milestones-group" style="display: none;">
            <label for="payment_milestones">Payment Milestones</label>
            <select id="payment_milestones" name="payment_milestones">
                <option value="">-- Select Milestones --</option>
                <option value="3">3 Milestone</option>
                <option value="4">4 Milestone</option>
                <option value="5">5 Milestone</option>
            </select>
        </div>
        
        <!-- Line Item 1 (Always Visible if milestones is selected) -->
        <div class="form-group line-item-wrapper" id="line-item-1" style="display: none;">
            <label>Line Item 1 (Amount/Due Date)</label>
            <div class="line-item-group">
                <div> 
                    <input type="text" name="line_item_amount_1" placeholder="Amount (Without Tax 1)" />
                </div>
                <div>
                    <input type="text" name="line_item_due_on_1" />
                </div>
            </div>
        </div>

        <!-- Line Item 2 -->
        <div class="form-group line-item-wrapper" id="line-item-2">
            <label>Line Item 2 (Amount/Due Date)</label>
            <div class="line-item-group">
                <div>
                    <input type="text" name="line_item_amount_2" placeholder="Amount (Without Tax 2)" />
                </div>
                <div>
                    <input type="text" name="line_item_due_on_2" />
                </div>
            </div>
        </div>
        
        <!-- Line Item 3 -->
        <div class="form-group line-item-wrapper" id="line-item-3">
            <label>Line Item 3 (Amount/Due Date)</label>
            <div class="line-item-group">
                <div>
                    <input type="text" name="line_item_amount_3" placeholder="Amount (Without Tax 3)" />
                </div>
                <div>
                    <input type="text" name="line_item_due_on_3" />
                </div>
            </div>
        </div>

        <!-- NEW: Line Item 4 (Initially hidden) -->
        <div class="form-group line-item-wrapper" id="line-item-4">
            <label>Line Item 4 (Amount/Due Date)</label>
            <div class="line-item-group">
                <div>
                    <input type="text" name="line_item_amount_4" placeholder="Amount (Without Tax 4)" />
                </div>
                <div>
                    <input type="text" name="line_item_due_on_4" />
                </div>
            </div>
        </div>

        <!-- NEW: Line Item 5 (Initially hidden) -->
        <div class="form-group line-item-wrapper" id="line-item-5">
            <label>Line Item 5 (Amount/Due Date)</label>
            <div class="line-item-group">
                <div>
                    <input type="text" name="line_item_amount_5" placeholder="Amount (Without Tax 5)" />
                </div>
                <div>
                    <input type="tezt" name="line_item_due_on_5" />
                </div>
            </div>
        </div>
        
        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 0.5rem 0 2rem;">
        
        <!-- Payment Terms Summary Fields -->
        <div class="form-group">
          <label for="payment_terms_summary_fees">Summary Fees (Optional)</label>
          <input type="text" id="payment_terms_summary_fees" name="payment_terms_summary_fees" placeholder="e.g., $1000 Total Fees" />
        </div>
        
        <div class="form-group">
          <label for="payment_terms_admin_fees">Admin Fees (Optional)</label>
          <input type="text" id="payment_terms_admin_fees" name="payment_terms_admin_fees" placeholder="e.g., $50 Admin Fee" />
        </div>
        
        <div class="form-group">
          <label for="payment_terms_taxes">Taxes (Optional)</label>
          <input type="text" id="payment_terms_taxes" name="payment_terms_taxes" placeholder="e.g., 13% HST" />
        </div>
        
        <div class="form-group">
          <label for="payment_terms_other_fees">Other Fees (Optional)</label>
          <input type="text" id="payment_terms_other_fees" name="payment_terms_other_fees" placeholder="e.g., $25 Courier Fee" />
        </div>


        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 0.5rem 0 2rem;">


        <!-- Company Details -->
        <div class="form-group">
          <label for="company_name">Company Name</label>
          <input type="text" id="company_name" name="company_name" placeholder="Acme Corporation" required />
        </div>

        <div class="form-group">
          <label for="company_address">Company Address</label>
          <input type="text" id="company_address" name="company_address"
            placeholder="456 Business Blvd, City, State 12345" required />
        </div>

        <!-- Primary Signer (Your/Internal Details) -->
        <div class="form-group">
          <label for="address_primary">Your Address</label>
          <input type="text" id="address_primary" name="address_primary" placeholder="123 Main St, City, State 12345"
            required />
        </div>

        <input type="hidden" name="esign_status" value="false" />
        <input type="hidden" name="payment_status" value="false" />

        <button type="submit" id="submitBtn" class="full-submit-button">
          <span id="btnText">Generate & Send Link</span>
        </button>
      </form>
    </div>

    <!-- Review Section (Hidden Initially, After Step 2 Submission) -->
    <div id="reviewSection" style="display: none; text-align: center;">
      <h3 style="margin-bottom: 1rem; color: #333;">Document Prepared</h3>
      <p style="margin-bottom: 2rem; color: #666;">
        Your document has been generated. Please review it before sending.
      </p>
      <a href="#" id="editDocLink" target="_blank" class="button-style" style="margin-bottom: 1rem;">
        Review & Edit Document
      </a>

      <!-- Back Button to edit details (Step 3 -> Step 2) -->
      <button id="backBtn" class="secondary-button" style="margin-top: 1rem;">
        Go Back and Edit Details
      </button>

      <button id="sendMailBtn" class="button-style" style="margin-top: 1rem;">
        <span id="sendBtnText">Looks Good, Send Mail</span>
      </button>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // CONSTANTS & ELEMENTS
    // ----------------------------------------------------
    const ESIGN_WEBHOOK_URL = "https://n8n.srv898271.hstgr.cloud/webhook/create-and-send-esign-link";
    const FIND_CLIENT_WEBHOOK_URL = "https://n8n.srv898271.hstgr.cloud/webhook/find-client-details-esign";

    // Stepper Elements
    const progressStep1 = document.getElementById('progress_step1');
    const progressStep2 = document.getElementById('progress_step2');
    const progressStep3 = document.getElementById('progress_step3');

    // Step Containers
    const findClientStep = document.getElementById('findClientStep'); // Step 1
    const reviewDetailsStep = document.getElementById('reviewDetailsStep'); // Step 2
    const reviewSection = document.getElementById("reviewSection"); // Step 3

    // Step 1 Elements
    const searchPhoneInput = document.getElementById('search_phone');
    const findClientBtn = document.getElementById('findClientBtn');
    const proceedManualBtn = document.getElementById('proceedManualBtn');

    // Step 2 Elements
    const esignForm = document.getElementById("esignForm");
    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const clientPhoneInput = document.getElementById('client_phone');
    const backToSearchBtn = document.getElementById('backToSearchBtn');
    
    // NEW DROPDOWN ELEMENTS
    const selectRetainer = document.getElementById('select_retainer');
    const paymentMilestonesGroup = document.getElementById('milestones-group');
    const paymentMilestones = document.getElementById('payment_milestones');
    const lineItemWrappers = [1, 2, 3, 4, 5].map(i => document.getElementById(`line-item-${i}`));

    // Step 3 Elements
    const editDocLink = document.getElementById("editDocLink");
    const sendMailBtn = document.getElementById("sendMailBtn");
    const sendBtnText = document.getElementById("sendBtnText");
    const backBtn = document.getElementById('backBtn');

    let finalizationData = {};
    let currentStep = 1;


    // ----------------------------------------------------
    // UTILITY FUNCTIONS
    // ----------------------------------------------------

    function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = "slideInRight 0.3s ease-out reverse";
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    function updateStep(step) {
        currentStep = step;

        // Reset display of containers
        findClientStep.style.display = 'none';
        reviewDetailsStep.style.display = 'none';
        reviewSection.style.display = 'none';
        
        // Reset all progress steps
        progressStep1.classList.remove('active');
        progressStep2.classList.remove('active');
        progressStep3.classList.remove('active');
        
        // Activate current step and show container
        if (step === 1) {
            progressStep1.classList.add('active');
            findClientStep.style.display = 'block';
        } else if (step === 2) {
            progressStep1.classList.add('active');
            progressStep2.classList.add('active');
            reviewDetailsStep.style.display = 'block';
            
            // Re-run the requirement and visibility check upon returning to step 2
            handleRetainerRequirements();
            handleMilestonesVisibility();
            
        } else if (step === 3) {
            progressStep1.classList.add('active');
            progressStep2.classList.add('active');
            progressStep3.classList.add('active');
            reviewSection.style.display = 'block';
        }
    }
    
    // ----------------------------------------------------
    // NEW: PAYMENT MILESTONE & RETAINER LOGIC
    // ----------------------------------------------------

    function handleMilestonesVisibility() {
        // Get the selected number of milestones (3, 4, or 5)
        const milestoneCount = parseInt(paymentMilestones.value, 10) || 0;
        
        // Loop through all 5 line item wrappers
        lineItemWrappers.forEach((wrapper, index) => {
            const lineItemNumber = index + 1; // 1, 2, 3, 4, 5
            
            if (lineItemNumber <= milestoneCount) {
                // Show the line item if its index is less than or equal to the selected count
                wrapper.style.display = 'block';
                // Line item inputs remain optional as per the request, 
                // but an actual payment flow might require them.
            } else {
                // Hide the line item
                wrapper.style.display = 'none';
                
                // OPTIONAL: Clear the hidden fields to prevent sending irrelevant data
                const amountInput = wrapper.querySelector(`input[name="line_item_amount_${lineItemNumber}"]`);
                const dateInput = wrapper.querySelector(`input[name="line_item_due_on_${lineItemNumber}"]`);
                if (amountInput) amountInput.value = '';
                if (dateInput) dateInput.value = '';
            }
        });
    }

    function handleRetainerRequirements() {
        const isRetainerSelected = selectRetainer.value !== "";
        
        if (isRetainerSelected) {
            // RETAINER IS SELECTED: Show milestones and make it required
            paymentMilestonesGroup.style.display = 'block';
            paymentMilestones.setAttribute('required', 'required');
        } else {
            // RETAINER IS NOT SELECTED: Hide milestones, make it optional, and clear/reset
            paymentMilestonesGroup.style.display = 'none';
            paymentMilestones.removeAttribute('required');
            paymentMilestones.value = ""; // Clear the selection
        }
        
        // Always run visibility logic, which handles hiding/clearing when milestones.value is cleared
        handleMilestonesVisibility();
    }


    // ----------------------------------------------------
    // STEP 1 HANDLERS (Find Client)
    // ----------------------------------------------------

    // Action when "Find Client" is clicked
    findClientBtn.addEventListener('click', async () => {
        const phoneNumber = searchPhoneInput.value.trim();

        if (phoneNumber === "") {
            showNotification("Please enter a phone number or proceed to manual entry.", "error");
            return;
        }

        findClientBtn.disabled = true;
        findClientBtn.innerHTML = '<span class="spinner"></span>Searching...';

        try {
          // 1. Fetch Client Details
          const requestBody = { phone_number: phoneNumber };
          const res = await fetch(FIND_CLIENT_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody) // Send the phone number to the webhook
          });

            findClientBtn.disabled = false;
            findClientBtn.innerHTML = '<span class="emoji">üîé</span> Find Client';

            if (!res.ok) {
                throw new Error(`Client lookup failed with status: ${res.status}`);
            }

            const _text = await res.text();
            let responseData = {};
            if (_text) {
              try {
                responseData = JSON.parse(_text);
              } catch (parseErr) {
                console.warn('Invalid JSON from find-client webhook:', parseErr, _text);
                showNotification('Received non-JSON response from find-client webhook (see console).', 'error');
                responseData = {};
              }
            } else {
              console.warn('Empty response body from find-client webhook, status:', res.status);
            }

            const clientFound = responseData && responseData.status === "success" && responseData.client;

            // Reset form fields before populating/moving
            esignForm.reset(); 
            clientPhoneInput.removeAttribute('required'); 

            if (clientFound) {
                const client = responseData.client;
                
                // 2. Map and Populate Fields
                document.getElementById('fname_primary').value = client.client_name || client.customerName || '';
                document.getElementById('lname_primary').value = ''; 

                document.getElementById('client_email').value = client.client_email || '';
                document.getElementById('client_phone').value = client.client_phone || phoneNumber;
                
                showNotification(`‚úÖ Client "${client.client_name || client.customerName}" details found and pre-filled!`, "success");
            } else {
                // If not found (or status is not success), proceed to manual entry
                document.getElementById('client_phone').value = phoneNumber; 
                document.getElementById('fname_primary').value = '';
                document.getElementById('lname_primary').value = '';
                showNotification("Client not found. Please review and enter details manually.", "error");
            }
            
            // 3. Move to Step 2
            updateStep(2);

        } catch (err) {
            console.error("Fetch Error:", err);
            findClientBtn.disabled = false;
            findClientBtn.innerHTML = '<span class="emoji">üîé</span> Find Client';
            
            document.getElementById('client_phone').value = phoneNumber; 
            document.getElementById('fname_primary').value = '';
            document.getElementById('lname_primary').value = '';
            updateStep(2);
            showNotification("‚ö†Ô∏è Connection/Search error. Please review details manually.", "error");
        }
    });

    // Action when "Proceed to Manual Entry" is clicked
    proceedManualBtn.addEventListener('click', (e) => {
        e.preventDefault();
        esignForm.reset(); 
        clientPhoneInput.removeAttribute('required');
        searchPhoneInput.value = ''; 
        updateStep(2);
    });

    // ----------------------------------------------------
    // STEP 2 HANDLERS (Review Details)
    // ----------------------------------------------------
    
    // Back to Search Button (Step 2 -> Step 1)
    backToSearchBtn.addEventListener('click', () => {
        updateStep(1); 
    });

    // 1. Event Listener for the full form submission (Step 2 logic)
    esignForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const formData = new FormData(esignForm);
      const data = Object.fromEntries(formData.entries());

      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>Generating Document...';

      try {
        console.debug('ESign - request body:', data);
        const res = await fetch(ESIGN_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const _text = await res.text();
        let responseData = {};
        if (_text) {
          try {
            responseData = JSON.parse(_text);
          } catch (parseErr) {
            console.warn('Invalid JSON from esign webhook:', parseErr, _text);
            showNotification('Received non-JSON response from esign webhook (see console).', 'error');
            responseData = {};
          }
        }

        if (res.ok) {
          finalizationData = responseData || {};

          showNotification("‚úÖ Document created successfully!", "success");

          // Update the "Edit Document" link if we have a documentId
          if (responseData && responseData.documentId) {
            editDocLink.href = `https://docs.google.com/document/d/${responseData.documentId}/edit`;
          } else {
            console.warn('No documentId returned from webhook; cannot build edit link.');
          }

          // Move to Step 3 (Review/Finalize)
          updateStep(3);

        } else {
          console.warn('ESign webhook returned non-OK status', res.status, _text);
          showNotification("‚ùå Failed to generate document. Please try again.", "error");
        }
      } catch (err) {
        console.error(err);
        showNotification("‚ö†Ô∏è Connection error. Please check your network.", "error");
      }
    });
    
    // ----------------------------------------------------
    // STEP 3 HANDLERS (Review/Finalize)
    // ----------------------------------------------------

    // Back Button Logic (Step 3 -> Step 2)
    backBtn.addEventListener('click', () => {
        updateStep(2); // Go back to Review Details (Step 2)
        submitBtn.disabled = false;
        btnText.textContent = "Generate & Send Link";
        sendMailBtn.disabled = false;
        sendBtnText.textContent = "Looks Good, Send Mail";
    });

    // Send Mail Button Logic
    sendMailBtn.addEventListener("click", async () => {
      sendMailBtn.disabled = true;
      sendBtnText.innerHTML = '<span class="spinner"></span>Sending...';

      try {
        const res = await fetch(ESIGN_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(finalizationData) // Send the stored data
        });

        if (res.ok) {
          showNotification("‚úÖ Email sent successfully!", "success");
          reviewSection.innerHTML = '<h3 style="color: #333;">All Done!</h3><p style="color: #666;">The email has been sent to the client. You can close this window now.</p>';
        } else {
          showNotification("‚ùå Failed to send email. Please try again.", "error");
        }
      } catch (err) {
        console.error(err);
        showNotification("‚ö†Ô∏è Connection error while sending email.", "error");
      } finally {
        if (reviewSection.querySelector('#sendMailBtn')) {
            sendMailBtn.disabled = false;
            sendBtnText.textContent = "Looks Good, Send Mail";
        }
      }
    });

    // ----------------------------------------------------
    // INITIALIZATION
    // ----------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        updateStep(1);
        
        // Attach change listeners for dynamic fields
        selectRetainer.addEventListener('change', handleRetainerRequirements);
        paymentMilestones.addEventListener('change', handleMilestonesVisibility);
    });
  </script>
</body>

</html>
